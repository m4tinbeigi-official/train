<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø·Ø§Ø± Ø­ÙˆÙ…Ù‡â€ŒØ§ÛŒ ØªÙ‡Ø±Ø§Ù† - Ù‚Ø±Ú†Ú©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: 'Vazir', sans-serif;
            background: url('https://example.com/train-bg.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
        }

        h1 {
            margin-top: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px #000000;
        }

        .container {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
        }

        .train-schedule {
            margin-top: 20px;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .list-group-item {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
        }

        .badge-success {
            background-color: #28a745;
        }

        /* Media queries Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú©ØªØ± */
        @media (max-width: 767px) {
            h1 {
                font-size: 1.5rem;
            }
            .container {
                padding: 10px;
            }
        }

        /* Ù‡Ø¯Ø± Ú†Ø³Ø¨Ø§Ù† */
        .sticky-header {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 10px;
            text-align: center;
            color: #fff;
            z-index: 1000;
            font-size: 1.2rem;
        }

        /* ÙÙˆØªØ± Ú†Ø³Ø¨Ø§Ù† */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 10px;
            text-align: center;
            color: #fff;
            font-size: 0.9rem;
        }

        /* ØªØ¨ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ */
        #alertTab {
            margin-top: 20px;
            display: none;
        }

    </style>
</head>
<body>
    <!-- Ù‡Ø¯Ø± Ú†Ø³Ø¨Ø§Ù† -->
    <div class="sticky-header">
        Ù‚Ø·Ø§Ø± Ø­ÙˆÙ…Ù‡â€ŒØ§ÛŒ ØªÙ‡Ø±Ø§Ù† - Ù‚Ø±Ú†Ú©
    </div>

    <div class="container" style="margin-top: 80px;">
        <h1 class="text-center">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø­Ø±Ú©Øª Ù‚Ø·Ø§Ø±</h1>
        <div class="mb-3">
            <label for="startPoint" class="form-label">Ù…Ø¨Ø¯Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</label>
            <select class="form-select" id="startPoint" onchange="updateSchedule()">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                <option value="tehran">ØªÙ‡Ø±Ø§Ù†</option>
                <option value="gharchak">Ù‚Ø±Ú†Ú©</option>
            </select>
        </div>

        <div id="schedule" class="train-schedule"></div>
        
        <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ù…Ø§Ù† Ù‡Ø´Ø¯Ø§Ø± -->
        <div class="mb-3">
            <label for="alertTime" class="form-label">Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„ Ù‡Ø´Ø¯Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯ØŸ</label>
            <select class="form-select" id="alertTime">
                <option value="15">15 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„</option>
                <option value="30">30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„</option>
                <option value="45">45 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„</option>
            </select>
        </div>

        <!-- Ú¯Ø²ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø± Ù‡Ø± Ø±ÙˆØ² -->
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="dailyAlert">
            <label class="form-check-label" for="dailyAlert">Ù‡Ø± Ø±ÙˆØ² Ø¨Ù‡ Ù…Ù† Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø¯Ù‡</label>
        </div>

        <button class="btn btn-primary w-100" onclick="detectLocation()">ØªØ´Ø®ÛŒØµ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>

        <button class="btn btn-secondary w-100 mt-3" onclick="showAlertTab()">Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</button>
    </div>

    <!-- ØªØ¨ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ -->
    <div id="alertTab" class="container">
        <h2>Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</h2>
        <ul id="alertList" class="list-group"></ul>
        <button class="btn btn-secondary w-100 mt-3" onclick="hideAlertTab()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <!-- ÙÙˆØªØ± Ú†Ø³Ø¨Ø§Ù† -->
    <div class="sticky-footer">
    Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ ğŸ¤ ØªÙˆØ³Ø· <strong>Ø±ÛŒÚ© Ø³Ø§Ù†Ú†Ø²</strong> Ø¨Ø§ Ø­Ù…Ø§ÛŒØª <a href="https://tapin.ir">ØªØ§Ù¾ÛŒÙ†</a> Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÙˆÙ†Øª <strong>ÙˆØ²ÛŒØ±</strong> Ø¨Ù‡ ÛŒØ§Ø¯ <strong>ØµØ§Ø¨Ø± Ø±Ø§Ø³ØªÛŒ Ú©Ø±Ø¯Ø§Ø±</strong> ğŸ•Šï¸
	</div>

    <script>
        let alarms = [];

        const schedules = {
            tehran: [
                { departure: "02:50", arrival: "03:22" },
                { departure: "06:10", arrival: "06:42" },
                { departure: "08:15", arrival: "08:47" },
                { departure: "11:15", arrival: "11:47" },
                { departure: "14:30", arrival: "15:02" },
                { departure: "15:30", arrival: "16:02" },
                { departure: "16:30", arrival: "17:02" },
                { departure: "17:20", arrival: "17:52" },
                { departure: "18:40", arrival: "19:12" },
                { departure: "19:30", arrival: "20:02" }
            ],
            gharchak: [
                { departure: "05:38", arrival: "06:10" },
                { departure: "06:56", arrival: "07:25" },
                { departure: "06:03", arrival: "06:35" },
                { departure: "09:21", arrival: "09:50" },
                { departure: "09:53", arrival: "10:25" },
                { departure: "16:08", arrival: "16:40" },
                { departure: "18:13", arrival: "18:45" },
                { departure: "18:36", arrival: "19:05" },
                { departure: "19:14", arrival: "19:45" },
                { departure: "20:38", arrival: "21:10" }
            ]
        };

        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬ÙˆØ² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
        function requestNotificationPermission() {
            if (Notification.permission === "default") {
                Notification.requestPermission();
            }
        }

        function updateSchedule() {
            const startPoint = document.getElementById('startPoint').value;
            const scheduleDiv = document.getElementById('schedule');
            scheduleDiv.innerHTML = ''; // Clear previous content

            if (!startPoint) return;

            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            const availableSchedules = schedules[startPoint]
                .filter(item => {
                    const [depHour, depMinute] = item.departure.split(':').map(Number);
                    const depTime = depHour * 60 + depMinute;
                    return depTime > currentTime;
                });

            if (availableSchedules.length === 0) {
                scheduleDiv.innerHTML = '<div class="alert alert-info">Ù‡ÛŒÚ† Ù‚Ø·Ø§Ø±ÛŒ Ø¯Ø± Ø§Ù…Ø±ÙˆØ² Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</div>';
                return;
            }

            let html = '<ul class="list-group">';
            availableSchedules.forEach(schedule => {
                const [depHour, depMinute] = schedule.departure.split(':').map(Number);
                const depTime = depHour * 60 + depMinute;

                const timeRemaining = depTime - currentTime;
                const hoursLeft = Math.floor(timeRemaining / 60);
                const minutesLeft = timeRemaining % 60;

                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Ø²Ù…Ø§Ù† Ø­Ø±Ú©Øª:</strong> ${schedule.departure}<br>
                                <strong>Ø²Ù…Ø§Ù† Ø±Ø³ÛŒØ¯Ù†:</strong> ${schedule.arrival}
                            </div>
                            <span class="badge badge-success">${hoursLeft} Ø³Ø§Ø¹Øª Ùˆ ${minutesLeft} Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</span>
                            <button class="btn btn-sm btn-warning" onclick="setAlarm(${depTime}, '${schedule.departure}')">ØªÙ†Ø¸ÛŒÙ… Ù‡Ø´Ø¯Ø§Ø±</button>
                         </li>`;
            });
            html += '</ul>';

            scheduleDiv.innerHTML = html;
        }

        // ØªÙ†Ø¸ÛŒÙ… Ù‡Ø´Ø¯Ø§Ø±
        function setAlarm(depTime, departure) {
            const alertTime = parseInt(document.getElementById('alertTime').value); // Ú¯Ø±ÙØªÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨Ú¯Ø±
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const timeUntilDeparture = depTime - currentTime;

            const timeUntilAlert = (timeUntilDeparture - alertTime) * 60 * 1000; // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡
            const dailyAlert = document.getElementById('dailyAlert').checked; // Ø¨Ø±Ø±Ø³ÛŒ Ú¯Ø²ÛŒÙ†Ù‡ Ù‡Ø± Ø±ÙˆØ²

            if (timeUntilAlert > 0) {
                const alarmId = setTimeout(() => {
                    sendNotification(departure);
                    if (dailyAlert) {
                        setAlarm(depTime + 24 * 60, departure); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† 24 Ø³Ø§Ø¹Øª Ø¨Ù‡ depTime
                    }
                }, timeUntilAlert);
                
                const alarmObj = { id: alarmId, time: departure, daily: dailyAlert, depTime: depTime };
                alarms.push(alarmObj);
                saveAlarmsToLocalStorage();
                updateAlarmList();
                alert(`Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø±Ø§ÛŒ ${alertTime} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø±Ú©Øª Ù‚Ø·Ø§Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯.`);
            } else {
                alert("Ø²Ù…Ø§Ù† Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù‡Ø´Ø¯Ø§Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ø¯Ø± LocalStorage
        function saveAlarmsToLocalStorage() {
            localStorage.setItem('alarms', JSON.stringify(alarms));
        }

        // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ø§Ø² LocalStorage
        function loadAlarmsFromLocalStorage() {
            const savedAlarms = JSON.parse(localStorage.getItem('alarms') || '[]');
            alarms = savedAlarms;
            alarms.forEach(alarm => {
                const timeUntilAlert = (alarm.depTime - new Date().getHours() * 60 + new Date().getMinutes()) * 60 * 1000;
                if (timeUntilAlert > 0) {
                    setTimeout(() => sendNotification(alarm.time), timeUntilAlert);
                }
            });
            updateAlarmList();
        }

        // Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
        function sendNotification(departure) {
            if (Notification.permission === "granted") {
                new Notification(`Ù‚Ø·Ø§Ø± Ø¯Ø± Ø³Ø§Ø¹Øª ${departure} Ø­Ø±Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯!`);
            } else {
                alert("Ù„Ø·ÙØ§Ù‹ Ù…Ø¬ÙˆØ² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.");
            }
        }

        // Ù†Ù…Ø§ÛŒØ´ ØªØ¨ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
        function showAlertTab() {
            document.querySelector(".container").style.display = "none";
            document.getElementById("alertTab").style.display = "block";
            updateAlarmList();
        }

        // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
        function hideAlertTab() {
            document.getElementById("alertTab").style.display = "none";
            document.querySelector(".container").style.display = "block";
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§
        function updateAlarmList() {
            const alertList = document.getElementById("alertList");
            alertList.innerHTML = '';

            alarms.forEach((alarm, index) => {
                const listItem = document.createElement("li");
                listItem.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center");
                listItem.innerHTML = `
                    <div>Ù‡Ø´Ø¯Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¹Øª ${alarm.time} ${alarm.daily ? '(Ù‡Ø± Ø±ÙˆØ²)' : ''}</div>
                    <button class="btn btn-sm btn-danger" onclick="removeAlarm(${index})">Ù„ØºÙˆ</button>
                `;
                alertList.appendChild(listItem);
            });
        }

        // Ù„ØºÙˆ Ù‡Ø´Ø¯Ø§Ø±
        function removeAlarm(index) {
            clearTimeout(alarms[index].id);
            alarms.splice(index, 1);
            saveAlarmsToLocalStorage();
            updateAlarmList();
        }

        function detectLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successLocation, errorLocation);
            } else {
                alert("Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø² Ù‚Ø§Ø¨Ù„ÛŒØª Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
            }
        }

        function successLocation(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªÙ‡Ø±Ø§Ù† Ùˆ Ù‚Ø±Ú†Ú© Ø¯Ø§Ø±Ø§ÛŒ Ù…Ø®ØªØµØ§Øª Ø²ÛŒØ± Ù‡Ø³ØªÙ†Ø¯
            const tehranCoords = { lat: 35.6892, lon: 51.3890 };
            const gharchakCoords = { lat: 35.4372, lon: 51.5727 };

            const distanceToTehran = getDistance(lat, lon, tehranCoords.lat, tehranCoords.lon);
            const distanceToGharchak = getDistance(lat, lon, gharchakCoords.lat, gharchakCoords.lon);

            if (distanceToTehran < distanceToGharchak) {
                document.getElementById('startPoint').value = "tehran";
            } else {
                document.getElementById('startPoint').value = "gharchak";
            }

            updateSchedule();
        }

        function errorLocation() {
            alert("Ø¹Ø¯Ù… Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ.");
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ù…ÙˆÙ„ Ù‡Ø§Ø¨Ø±Ø³Ø§ÛŒÙ† (Haversine Formula)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Ø´Ø¹Ø§Ø¹ Ø²Ù…ÛŒÙ† Ø¨Ù‡ Ú©ÛŒÙ„ÙˆÙ…ØªØ±
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lat2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // ÙØ§ØµÙ„Ù‡ Ø¨Ù‡ Ú©ÛŒÙ„ÙˆÙ…ØªØ±
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø¬ÙˆØ² Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
        window.onload = () => {
            requestNotificationPermission();
            loadAlarmsFromLocalStorage();
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
